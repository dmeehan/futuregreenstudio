{% extends "base.html" %}

{% load wagtailcore_tags wagtailimages_tags %}

{% block body_class %}body--home {% if page.slideshow_images %}theme-{{ page.slideshow_images.all.0.theme }}{% endif %}
{% endblock %}

{% block content %}
    {% if page.slideshow_images %}
    <ul class="slideshow js-slideshow-fullscreen">  
    {% for item in page.slideshow_images.all %}
        <li data-theme="{{ item.theme }}" id="slideshow-item-{{ item.id }}">
            {% if item.link_page %}
            <a href="{{ item.link_page.url }}">
            {% endif %}
             {% image item.image original as img %}
             <img data-src="{{ img.url }}" />
             {% if item.caption %}
                <span class="slideshow-caption js-pause-on-hover">{{ item.caption|richtext }}</span>
             {% endif %}
            {% if item.link_page %}
            </a>
            {% endif %}
        </li>
    {% endfor %}
    </ul>
    <ul class="slideshow-nav js-slideshow-nav js-pause-on-hover">
      {% for item in page.slideshow_images.all %}
      <li class="slideshow-nav-item">
        <button type="button" data-target="slideshow-item-{{ item.id }}" class="js-slideshow-nav-button">
          <span>{{ item.image }}</span>
          </button>
        </li>
      {% endfor %}
    </ul>
    {% endif %}
{% endblock %}
{% block footer %}{% endblock %}
{% block extra_js %}    
    <script>
        $(document).ready(function(){
            var $slideshow = $('.js-slideshow-fullscreen');
            var $firstSlide = $slideshow.find('li:first');
            var $secondSlide = $firstSlide.next();
            var $firstImg = $firstSlide.find('img');
            var $secondImg = $secondSlide.find('img');

            //$('body').addClass('theme-' + $firstSlide.data('theme'));

            var hasObjectFit = ('objectFit' in document.documentElement.style);

            // load the first two images in the slideshow
            $firstImg.attr('src', $firstImg.data('src'));
            $secondImg.attr('src', $secondImg.data('src'));
            
            // if the browser does not support object fit, add the image as a background image and add a class to apply proper style
            if (!hasObjectFit) {
              $firstImg.parent().css('backgroundImage', 'url(' + $firstImg.data('src') + ')').addClass('compat-object-fit');
              $secondImg.parent().css('backgroundImage', 'url(' + $secondImg.data('src') + ')').addClass('compat-object-fit');
            }
            
            // show the first slide
            $firstSlide.addClass('is-active');
            $('.js-slideshow-nav li:first button').addClass('is-active');

            function nextSlide() {
              // load the next unloaded image
              var $nextImgToLoad = $slideshow.find('img:not([src])').first();
              if ($nextImgToLoad.length) {
                $nextImgToLoad.attr('src', $nextImgToLoad.data('src'))
                // if the browser does not support object fit, add the image as a background image and add a class to apply proper style
                if (!hasObjectFit) {
                  $nextImgToLoad.parent().css('backgroundImage', 'url(' + $nextImgToLoad.data('src') + ')').addClass('compat-object-fit');
                } 
              };

              // show the next slide
              var $currentSlide = $slideshow.find('li.is-active'); 
              var $nextSlide = $currentSlide.next().length ? $currentSlide.next() : $firstSlide;

              $currentSlide.removeClass('is-active');
              $nextSlide.addClass('is-active');
              $('.js-slideshow-nav-button').removeClass('is-active');
              $('.js-slideshow-nav-button[data-target=' + $nextSlide.attr('id') + ']').addClass('is-active');

              $('body').attr('class', 'body--home');
              $('body').addClass('theme-' + $nextSlide.data('theme'));
            }

            var timer = setInterval(nextSlide, 6000);


            $('.js-slideshow-nav-button').click(function() {
                $(this).addClass('is-active');
                $(this).parent().siblings().find('button').removeClass('is-active');
                $('.js-slideshow-fullscreen li.is-active').removeClass('is-active');
                $('#' + $(this).data('target')).addClass('is-active');
                $('body').attr('class', 'body--home');
                $('body').addClass('theme-' + $('#' + $(this).data('target')).data('theme'));
            });

            $('.js-pause-on-hover').hover(function(e){
                clearInterval(timer);
            }, function(e){
                timer = setInterval(nextSlide, 6000);
            });
        });
    </script>
{% endblock %}
